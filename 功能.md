# **功能实现逻辑说明（完善版）**

## **一、整体流程概述**

软件基于 **低功耗蓝牙（BLE）** 与硬件设备通信，实现设备连接、数据采集、模式控制及参数校准等功能。整体流程如下：

1. App / 小程序启动
2. 蓝牙状态检测
3. 设备扫描与连接
4. 特征值自动解析
5. 进入控制与数据展示页面
6. 周期性数据读取
7. 模式控制与参数写入
8. 异常处理与断连重连

---

## **二、首页与蓝牙初始化逻辑**

### **1. 蓝牙状态检测**

- 软件启动后立即检测系统蓝牙状态
- 若蓝牙未开启：
  - 弹出提示：“请开启蓝牙以连接设备”
  - 引导用户前往系统设置开启蓝牙
- 蓝牙开启后，进入设备扫描流程

---

## **三、设备扫描与连接逻辑**

### **1. 设备扫描**

- 用户点击「扫描设备」按钮后：
  - 启动 BLE 扫描
  - 展示附近可用的低功耗蓝牙设备列表
- 可选过滤规则（推荐）：
  - 设备名称前缀
  - Service UUID
  - MAC 地址白名单

### **2. 设备连接**

- 用户点击目标设备后：
  - 发起 BLE 连接请求
  - 连接成功后进入服务发现流程
- 连接失败：
  - 提示失败原因
  - 支持重新连接

---

## **四、特征值自动分析与通信能力确认**

### **1. 特征值解析**

连接成功后，系统自动完成：

- 发现设备 GATT 服务
- 解析特征值（Characteristic）属性
- 确认以下能力：
  - ✅ 可写（Write / Write Without Response）
  - ✅ 可读（Read）
  - ✅ 可通知 / 回调（Notify / Indicate）

### **2. 通信通道确认**

- 确定：
  - 指令写入特征值
  - 数据回调特征值
- 订阅通知（Notify），用于接收设备实时数据

---

## **五、控制页面逻辑**

连接成功后，自动跳转至 **设备控制页面**，主要功能包括：

- 实时数据展示
- 模式切换
- 转速校准
- 连接状态显示

---

## **六、硬件数据获取机制**

### **1. 数据请求方式**

- 由 App / 小程序主动发送数据获取指令
- 指令内容：



复制代码

`7E 7F 50 FB FD`  

- 发送频率：
  - **300ms 轮询一次**
  - 可在配置中调整（防止功耗或数据拥堵）

### **2. 数据接收方式**

- 设备通过 BLE Notify 回调返回数据
- 回调数据由 App 统一解析

---

## **七、回调数据结构定义**

设备返回的数据结构如下（小端 / 大端需明确，建议文档中标注）：

```
助手返回的数据示例

20:13:29.680> 【TX】7E 7F 50 FB FD
20:13:29.691> 【RX】7E 7F 30 00 00 00 00 00 00 00 00 00
20:13:29.691> 【RX】00 00 00 00 00 00 00 00 00 00 00 00
20:13:29.696> 【RX】00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
20:13:29.699> 【RX】00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 33 33 33 3F DC 05 00 00 01 00 00 00
```

复制代码

`typedef struct STRUCT_SENSOR_MSG {`  
    `float VoltA_in;    // 模拟A输入`  
    `float VoltA_out;   // 模拟A输出`  

```
`float VoltB_in;    // 模拟B输入`  
`float VoltB_out;   // 模拟B输出`  

`float VoltC_in;    // 模拟C输入`  
`float VoltC_out;   // 模拟C输出`  

`float VoltD_in;    // 模拟D输入`  
`float VoltD_out;   // 模拟D输出`  

`float VoltE_in;    // 模拟E输入`  
`float VoltE_out;   // 模拟E输出`  

`float Fre_in;      // 频率信号输入`  
`float Fre_out;     // 压力值（4字节）`  

`int   RPM;         // 发动机转速（4字节）`  
`int   ModeNum;     // 当前工作模式（4字节）`  
```

`} STRUCT_SENSOR_MSG;`  

> 说明：

- 所有 `float` 占 4 字节
- `int` 占 4 字节
- 数据总长度需与 BLE 单包/分包机制匹配

---

## **八、工作模式控制指令**

### **1. 模式切换指令说明**


| **模式** | **指令**       | **描述** |
| ------ | ------------ | ------ |
| E      | `7E7F00FBFD` | 经济模式   |
| N      | `7E7F01FBFD` | 标准模式   |
| S      | `7E7F02FBFD` | 运动模式   |
| S+     | `7E7F03FBFD` | 超级运动模式 |
| R      | `7E7F04FBFD` | 倒车模式   |


### **2. 模式切换流程**

1. 用户点击模式按钮
2. App 发送对应指令
3. 设备切换模式
4. 通过回调数据中的 `ModeNum` 校验当前模式状态

---

## **九、转速校准指令**

### **1. 指令格式**

```
s
```

复制代码

`7E 7F 60 [RPM值] FB FD`  

- `[RPM值]`：
  - 4 字节十六进制
  - 范围：`0000 – 9999`
  - 高低字节顺序需与设备协议一致

### **2. 示例**

```
r
```

复制代码

`7E 7F 60 00 00 FB FD`  

表示转速校准值为 **0**

### **3. 校准流程**

1. 用户输入目标转速值
2. App 校验输入合法性
3. 转换为 4 字节十六进制
4. 发送校准指令
5. 等待设备响应并更新数据显示

---

## **十、异常处理与边界逻辑（建议补充）**

### **1. 蓝牙异常**

- 蓝牙关闭 → 中断通信并提示
- 信号弱 → 提示“连接不稳定”

### **2. 通信异常**

- 指令超时未响应
- 数据格式错误
- 校验失败（如可加 CRC）

### **3. 断连处理**

- 自动尝试重连
- 多次失败后提示用户手动重连

---

## **十一、可扩展建议（非必需）**

- 增加心跳指令，检测设备在线状态
- 数据获取改为：
  - 主动请求 / 被动推送 可配置
- 支持日志记录（调试 / 售后）

